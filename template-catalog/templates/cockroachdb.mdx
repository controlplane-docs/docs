---
title: CockroachDB
---

## Overview

CockroachDB is a distributed SQL database that provides automatic replication, horizontal scalability, and built-in fault tolerance across multiple regions. This template deploys a multi-region CockroachDB cluster on Control Plane as a stateful workload with replica-direct load balancing.

Each location runs a configurable number of replicas that discover and join one another using Control Plane's internal DNS. On first deployment, the cluster initializes itself, creates a database and user, registers all regions, and sets the survival goal to `SURVIVE REGION FAILURE`.

### What Gets Created

- **GVC** — A dedicated GVC with static placement across the configured locations.
- **Stateful Workload** — CockroachDB (`v25.4.0`) with per-location replica scaling and replica-direct load balancing.
- **Volume Set** — Persistent ext4 storage (general-purpose-ssd) with final snapshot creation and 7-day retention.
- **Identity & Policy** — An identity bound to the workload with `reveal` access to the startup and user secrets.
- **Secrets** — A startup script for cluster join/initialization and an opaque secret for the database user credential.

### Architecture

CockroachDB uses the [Raft consensus protocol](https://www.cockroachlabs.com/docs/stable/architecture/replication-layer#raft) to replicate data across nodes. Each Control Plane location maps to a CockroachDB locality region, and replicas advertise their address via internal DNS (`replica-N.WORKLOAD.LOCATION.GVC.cpln.local`).

With 3 or more regions and the `SURVIVE REGION FAILURE` survival goal, the cluster tolerates the complete loss of one region without impacting availability.

## Prerequisites

This template has no external prerequisites. To install, follow the instructions for your preferred method:

<CardGroup cols={2}>
  <Card title="UI" href="/template-catalog/install-manage/ui" />
  <Card title="CLI" href="/template-catalog/install-manage/cli" />
  <Card title="Terraform" href="/template-catalog/install-manage/terraform" />
  <Card title="Pulumi" href="/template-catalog/install-manage/pulumi" />
</CardGroup>

## Configuration

The default `values.yaml` for this template:

```yaml
gvc:
  name: cockroach-gvc
  locations:
    - name: aws-us-east-2
      replicas: 3
    - name: aws-eu-central-1
      replicas: 3
    - name: aws-us-west-2
      replicas: 3

resources:
  cpu: 2000m
  memory: 4096Mi

database:
  name: mydb
  user: myuser

volumeset:
  capacity: 10 # initial capacity in GiB (minimum is 10)

cockroach_defaults:
  sql_port: 26257
  http_port: 8080

internal_access:
  type: same-gvc # options: same-gvc, same-org, workload-list
  workloads: # Note: can only be used if type is same-gvc or workload-list
    #- //gvc/GVC_NAME/workload/WORKLOAD_NAME
```

### Locations and Replicas

Configure the `gvc.locations` section to control which regions the cluster spans and how many replicas run in each.

<Note>
While CockroachDB can run on 2 locations, a minimum of 3 locations with 3 replicas per location is recommended. This is the minimum required for CockroachDB to survive a full region failure.
</Note>

Setting a location's `replicas` to `0` suspends the workload in that location without removing it from the configuration.

### Database Initialization

The `database` section specifies a database and user to create automatically when the cluster first initializes:

```yaml
database:
  name: mydb
  user: myuser
```

The created user is granted full access to the specified database. These values are only applied on the first initialization — they are skipped if the cluster has already been initialized (e.g., after a restart or upgrade).

### Resources and Storage

- `resources.cpu` and `resources.memory` set the CPU and memory allocated to each CockroachDB replica.
- `volumeset.capacity` sets the initial persistent volume size in GiB (minimum 10).

### Internal Access

The `internal_access` section controls which workloads can reach the CockroachDB cluster internally:

| Type | Description |
|------|-------------|
| `same-gvc` | Allow access from all workloads in the same GVC |
| `same-org` | Allow access from all workloads in the same organization |
| `workload-list` | Allow access only from specific workloads listed in `workloads` (can be combined with `same-gvc`) |

When using `workload-list`, specify each workload using its full link format:

```yaml
internal_access:
  type: workload-list
  workloads:
    - //gvc/GVC_NAME/workload/WORKLOAD_NAME
```

### Connecting to CockroachDB

Once deployed, the SQL interface is available on port 26257 (default). You can connect from a workload within the same GVC using:

```bash
cockroach sql --insecure
```

The DB Console (HTTP UI) is available on port 8080 for monitoring cluster health, query performance, and node status.

<Note>
This template deploys CockroachDB in insecure mode (no TLS). It is intended for internal workloads that connect through Control Plane's internal network.
</Note>

<Note>
This template creates a GVC with a default name defined in the values file. If you plan to deploy multiple instances, you **must assign a unique GVC name** for each deployment.
</Note>

## External References

- [CockroachDB Documentation](https://www.cockroachlabs.com/docs/stable/)
- [Multi-Region Overview](https://www.cockroachlabs.com/docs/stable/multiregion-overview)
- [Survive Region Failure](https://www.cockroachlabs.com/docs/stable/alter-database#survive-region-failure)

<Card title="CockroachDB Template" icon="github" href="https://github.com/controlplane-com/templates/tree/main/cockroach">
  View the source files, default values, and chart definition.
</Card>