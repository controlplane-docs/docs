---
title: JuiceFS Shared Filesystem
---

## Overview

The JuiceFS add-on enables shared filesystem (read-write-many) storage for Kubernetes workloads running on a managed Kubernetes cluster. JuiceFS is a distributed filesystem that stores data in object storage (S3, GCS, Azure Blob, or S3-compatible storage like MinIO) while using Redis for metadata.

When enabled, this add-on automatically deploys:

- **JuiceFS CSI Driver** - Handles volume provisioning and mounting
- **Redis Sentinel Cluster** - Stores filesystem metadata with high availability

## Supported Providers

This add-on works with all mk8s providers:

- [AWS](../aws)
- [Azure](../azure)
- [GCP](../gcp)
- [Hetzner](../hetzner)
- [Linode](../linode)
- [DigitalOcean](../digitalocean)
- [Generic](../generic)

## Prerequisites

1. An object storage bucket accessible from your cluster:
   - AWS S3
   - Google Cloud Storage (GCS)
   - Azure Blob Storage
   - MinIO or S3-compatible storage

2. A Control Plane opaque secret containing storage credentials

## How to Enable

### Step 1 - Create Storage Credentials Secret

Create an opaque secret in Control Plane containing your storage credentials. The secret payload must be a JSON object.

**For S3, Azure Blob, or MinIO:**

```yaml YAML
kind: secret
name: juicefs-creds
type: opaque
data:
  encoding: plain
  payload: '{"accessKey":"YOUR_ACCESS_KEY","secretKey":"YOUR_SECRET_KEY"}'
```

**For Google Cloud Storage:**

```yaml YAML
kind: secret
name: juicefs-creds
type: opaque
data:
  encoding: plain
  payload: '{"serviceAccountJson": "{ ... your GCP service account JSON ... }"}'
```

Apply the secret:

```bash
cpln apply -f secret.yaml --org YOUR_ORG
```

### Step 2 - Enable the Add-on

The JuiceFS add-on can be enabled during cluster creation or on an existing cluster.

#### Through Cluster Manifest

Add the following to your cluster manifest:

```yaml YAML
spec:
  addOns:
    juiceFS:
      storageSecretLink: //secret/juicefs-creds
      storageType: s3  # or 'gs', 'wasb', 'minio'
      bucket: https://my-bucket.s3.us-east-1.amazonaws.com
```

#### Using the Console

1. Navigate to your Kubernetes cluster in the [Control Plane Console](https://console.cpln.io/console/)
2. Go to `Add-ons`
3. Find `JuiceFS` and toggle it on
4. Configure the required fields:
   - **Storage Secret Link**: Link to your opaque secret (e.g., `//secret/juicefs-creds`)
   - **Storage Type**: Select your storage backend (`s3`, `gs`, `wasb`, or `minio`)
   - **Bucket**: Full URL to your object storage bucket

## Configuration Options

| Field | Required | Description |
|-------|----------|-------------|
| `storageSecretLink` | Yes | Link to the opaque secret containing credentials |
| `storageType` | Yes | Storage backend: `s3`, `gs`, `wasb`, or `minio` |
| `bucket` | Yes | Full bucket URL (see examples below) |
| `redis.replicas` | No | Number of Redis replicas (default: 3) |
| `redis.storage` | No | Storage per Redis replica (default: 8Gi) |
| `redis.minCpu` | No | Minimum CPU for Redis (default: 10m) |
| `redis.maxCpu` | No | Maximum CPU for Redis (default: 2001m) |
| `redis.minMemory` | No | Minimum memory for Redis (default: 100Mi) |
| `redis.maxMemory` | No | Maximum memory for Redis (default: 1000Mi) |

### Bucket URL Examples

- **AWS S3**: `https://my-bucket.s3.us-east-1.amazonaws.com`
- **Google Cloud Storage**: `gs://my-bucket`
- **Azure Blob**: `https://mystorageaccount.blob.core.windows.net/my-container`
- **MinIO (in-cluster)**: `http://minio.minio-namespace.svc:9000/my-bucket`

## Usage Instructions

After enabling the JuiceFS add-on, you can create shared volumes using the automatically provisioned storage class.

### Available Storage Classes

| Storage Class | Reclaim Policy | Binding Mode |
|---------------|----------------|--------------|
| `juicefs-shared` | Retain | WaitForFirstConsumer |
| `juicefs-shared-delete` | Delete | Immediate |

### Example: Creating a Shared Volume

Create a `PersistentVolumeClaim` using the JuiceFS storage class:

```yaml YAML
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: shared-data
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: juicefs-shared
  resources:
    requests:
      storage: 10Gi
```

### Example: Multiple Pods Sharing Storage

This example demonstrates two pods sharing the same volume:

```yaml YAML
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: shared-workspace
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: juicefs-shared
  resources:
    requests:
      storage: 50Gi
---
apiVersion: v1
kind: Pod
metadata:
  name: writer
spec:
  containers:
    - name: writer
      image: alpine:latest
      command: ['/bin/sh', '-c', 'while true; do echo $(date) >> /data/log.txt; sleep 5; done']
      volumeMounts:
        - name: shared
          mountPath: /data
  volumes:
    - name: shared
      persistentVolumeClaim:
        claimName: shared-workspace
---
apiVersion: v1
kind: Pod
metadata:
  name: reader
spec:
  containers:
    - name: reader
      image: alpine:latest
      command: ['/bin/sh', '-c', 'tail -f /data/log.txt']
      volumeMounts:
        - name: shared
          mountPath: /data
  volumes:
    - name: shared
      persistentVolumeClaim:
        claimName: shared-workspace
```

## Using with MinIO

JuiceFS works seamlessly with MinIO deployed on your cluster. You can deploy MinIO using the Control Plane template catalog or manually.

### Example: MinIO Integration

1. Deploy MinIO on your cluster (via template catalog or manually)

2. Create the credentials secret pointing to MinIO:

```yaml YAML
kind: secret
name: juicefs-minio-creds
type: opaque
data:
  encoding: plain
  payload: '{"accessKey":"minioadmin","secretKey":"minioadmin"}'
```

3. Enable JuiceFS with MinIO backend:

```yaml YAML
spec:
  addOns:
    juiceFS:
      storageSecretLink: //secret/juicefs-minio-creds
      storageType: minio
      bucket: http://minio.minio-namespace.svc:9000/juicefs-bucket
```

<Note>
Ensure the MinIO bucket exists before creating JuiceFS volumes. You can create buckets using the MinIO console or `mc` CLI.
</Note>

## Troubleshooting

### Volume Creation Fails

If PVC creation fails, check the JuiceFS CSI driver logs:

```bash
kubectl logs -n juicefs -l app=juicefs-csi-controller -c juicefs-plugin
```

Common issues:
- Invalid credentials in the secret
- Bucket does not exist or is not accessible
- Incorrect bucket URL format

### Pods Stuck in ContainerCreating

If pods using JuiceFS volumes are stuck:

1. Check the CSI node driver:
```bash
kubectl get pods -n juicefs -l app=juicefs-csi-node
```

2. Check CSI driver logs:
```bash
kubectl logs -n juicefs -l app=juicefs-csi-node -c juicefs-plugin
```

### Redis Connection Issues

Verify Redis is running:

```bash
kubectl get pods -n juicefs -l app=juicefs-redis
kubectl get pods -n juicefs -l app=juicefs-redis-sentinel
```

Test Redis connectivity:

```bash
kubectl exec -n juicefs juicefs-redis-0 -- redis-cli ping
```
