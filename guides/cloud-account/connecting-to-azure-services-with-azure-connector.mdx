### Azure Connector

- Cloud Account Creation

  - When registering a cloud account targeting Azure using the console, your organization's Azure administrator will use the Azure CLI to perform the following:
    - Create an `Azure Function App` using an existing resource group and storage account.
    - Download the Control Plane Azure connector code.
    - Deploy the code to the function app.
    - Obtain the URL of the deployed function.
    - Obtain the code/key of the deployed function.
  - After the registration is completed, a secret of type [azure-connector](/reference/secret#azure-connector) will be created. This secret can be reused to create another cloud account (using the same Function App) or if an existing cloud account was inadvertently deleted.

- Functionality

  - The Function App that is deployed has a function called `iam-broker`. This function is called by Control Plane to obtain and inject the access token on behalf of the calling workload.
  - The Function App is set as an `Owner` of the subscription. This role assignment is needed to create the managed identities.

- Identity Creation

  - When an [identity](/reference/identity) is created targeting Azure resources, a managed identity is assigned to the function so that the function can act on its behalf. This [identity](/reference/identity) will only have the minimum permissions that are required to access the targeted services. When an [identity](/reference/identity) is assigned to a [workload](/concepts/workload) that requests access to an Azure resource, Control Plane will obtain a temporary access token that impersonates the roles and inject it into the [workload](/concepts/workload) granting it access.

- Pricing

  - The App Function runs as a managed service and is subject to charges against your Azure subscription.
  - Please visit the [Azure Function Pricing](https://azure.microsoft.com/en-us/pricing/details/functions/)
    page to view the current pricing.

- Compromised Code

  - If the Function App code has been compromised, perform the following:

    - From the Azure portal:
      - In the search bar, enter `Function App` and click the first result.
      - Click the app to update and click `Functions`.
      - Click `iam-broker` and then click `Function Keys`.
      - For the `default` Function Key, click `Renew key value`. A confirmation modal will be displayed, click `Renew`.
      - After the new key has been generated, click the link `Hidden value. Click to show value`.
      - Copy the value of the new code to the clipboard.
    - From the Control Plane console:
      - Click `Secrets` in the left menu and select the `azure-connector` secret that belongs to the cloud account (it will be named
        CLOUD_ACCOUNT_NAME-access).
      - Click the `Edit Data` button and then click the eye icon.
      - Update the `Code` property with the value of the new code by pasting it from the clipboard.

  - Until a valid code has been updated, Control Plane will not be able to manage workload [identities](/reference/identity).
